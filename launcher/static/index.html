<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.gif" type="image/x-icon"/>
    <title>Electronvolt Launcher</title>
    <link rel="stylesheet" href="style.css" Type="text/css"/>
</head>
<body>
    <h1>Welcome!</h1>
    <button id="btn_launch">Launch Electronvolt</button>
    <div id="auth_form">
        <h2>Sign in with your<br>GameJolt account (optional)</h2>
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="token" placeholder="Game token" required>
        <label class="show_token">
        <input type="checkbox" id="toggle_token"> Show token
        </label>
        <button id="btn_login">Login</button>
    </div>
    <button id="btn_logout" class="hidden">ðŸ”“ Logout</button>
    <button id="btn_close">Exit</button>
    <div id="auth_popup" class="popup hidden">
        <div class="popup_content" id="popup_text">Authorization result</div>
    </div>
    <script>
        var btnLaunch = document.getElementById("btn_launch");
        var authForm = document.getElementById("auth_form");
        var toggleToken = document.getElementById("toggle_token");
        var btnLogin = document.getElementById("btn_login");
        var btnLogout = document.getElementById("btn_logout");
        var btnClose = document.getElementById("btn_close");
        
        var gjUserData = {
            username: "",
            token: ""
        };
        
        function apiRequest(url, data, callback) {
            var req = new XMLHttpRequest();
            req.onreadystatechange = function() {
                if (req.readyState == 4) {
                    callback(req.status, req.responseText);
                }
            };
            req.open("POST", url, true);
            req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            var params = Object.keys(data).map(
                key => encodeURIComponent(key) + '=' + encodeURIComponent(data[key])
            ).join('&');
            req.send(params);
        }
        
        btnLaunch.onclick = function(e) {
            btnLaunch.disabled = true;
            window.pywebview.api.launchGame();
        };
        
        var popupTimeout;
        function showNotification(message, success = true) {
            var popup = document.getElementById("auth_popup");
            var popupText = document.getElementById("popup_text");
            popupText.textContent = message;
            popup.style.color = success ? '#00ffc8' : '#ff7070';
            popup.style.borderColor = success ? '#00aaff' : '#ff5050';
            popup.style.boxShadow = success
                ? '0 0 10px rgba(0, 255, 200, 0.4), 0 0 20px rgba(0, 170, 255, 0.2)'
                : '0 0 10px rgba(255, 100, 100, 0.4), 0 0 20px rgba(255, 50, 50, 0.2)';
            popup.classList.remove('hidden');
            if (popupTimeout) {
                clearTimeout(popupTimeout);
                popupTimeout = null;
            }
            popupTimeout = setTimeout(function() {
                popup.classList.add('hidden');
            }, 3000);
        }
        
        var loginUrl = "https://xtreme3d.ru/gamejolt-server/login.php";
        
        function tryLogin() {
            apiRequest(loginUrl, gjUserData, function(status, data) {
                if (status == "200") {
                    var response = JSON.parse(data);
                    console.log(response);
                    var success = response.success == "true";
                    if (success) {
                        authForm.style.display = "none";
                        btnLogout.classList.remove("hidden");
                        showNotification("Logged in successfully!", true);
                        window.pywebview.api.setUserData(gjUserData);
                    }
                    else {
                        showNotification("Login failed! " + response.message || "", false);
                        activateLoginForm();
                    }
                }
                else {
                    showNotification("Login failed! HTTP error " + status, false);
                    activateLoginForm();
                }
            });
        }
        
        function deactivateLoginForm() {
            authForm.style.pointerEvents = "none";
            authForm.style.opacity = "0.6";
        }
        
        function activateLoginForm() {
            authForm.style.display = "flex";
            authForm.style.pointerEvents = "auto";
            authForm.style.opacity = "1.0";
        }
        
        toggleToken.addEventListener("change", function () {
            const tokenInput = document.getElementById("token");
            tokenInput.type = this.checked ? "text" : "password";
        });
        
        btnLogin.onclick = function(e) {
            gjUserData.username = document.getElementById("username").value;
            gjUserData.token = document.getElementById("token").value;
            deactivateLoginForm();
            tryLogin();
        };

        btnLogout.onclick = function() {
            window.pywebview.api.deleteUserData();
            document.getElementById("username").value = "";
            document.getElementById("token").value = "";
            btnLogout.classList.add("hidden");
            activateLoginForm();
            showNotification("Logged out");
        };
        
        btnClose.onclick = function() {
            window.pywebview.api.close();
        };
        
        // Subscribe to launcher events
        window.onmessage = function(e) {
            if (e.data.event == "game_status_change") {
                console.log(e.data.event, e.data.status);
                if (e.data.status == "running")
                    btnLaunch.disabled = true;
                else
                    btnLaunch.disabled = false;
            }
            else if (e.data.event == "autologin") {
                console.log(e.data.event);
                if ("username" in e.data && "token" in e.data) {
                    gjUserData.username = e.data.username;
                    gjUserData.token = e.data.token;
                    document.getElementById("username").value = gjUserData.username;
                    document.getElementById("token").value = gjUserData.token;
                    deactivateLoginForm();
                    tryLogin();
                }
            }
        };
    </script>
</body>
</html>
